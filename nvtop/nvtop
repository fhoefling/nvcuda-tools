#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# reformat output of the nvidia-smi tool
#
# Copyright © 2011   Felix Höfling
#
# This tool is free software and released under the terms of
# the GNU General Public License Version 3, please refer to
# <http://www.gnu.org/licenses/> for details.

from subprocess import Popen, PIPE
from xml.etree import ElementTree
from re import sub

# grab output of nvidia-smi tool
try:
    nvsmi = Popen(['nvidia-smi', '-a', '-x'], stdout=PIPE).communicate()[0]
except:
    raise SystemExit("Error while reading from nvidia-smi")

# parse XML
xmlt = ElementTree.XML(nvsmi)

# print header
print '''\
ID  Name            Utilization     Temperature     Fan Speed
                    GPU   Memory'''

# retrieve GPU information from XML groups
for id,gpu in enumerate(xmlt.getiterator(tag="gpu")):
    info = {}
    info["id"] = '{0:d}'.format(id)
    info["name"] = gpu.findtext("prod_name") or gpu.findtext("product_name") or "n/a"
    info["temp"] = gpu.findtext("temp") or gpu.findtext("temperature/gpu_temp") or ""
    info["fan"] = gpu.findtext("fan_speed") or ""
    info["gpu_util"] = gpu.findtext("utilization/gpu_util") or ""
    info["mem_util"] = gpu.findtext("utilization/memory_util") or ""

    info["name"] = sub(' Processor', '', info["name"]) # simplify name

    # output data in one line
    print '{id:4s}{name:16s}{gpu_util:8s}{mem_util:8s}{temp:16s}{fan:16s}'.format(**info)
